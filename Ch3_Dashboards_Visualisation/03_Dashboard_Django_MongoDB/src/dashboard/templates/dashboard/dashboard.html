{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Dashboard Capteurs</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>

<body>
    <div class="container mt-4">
        <h1>Dashboard Capteurs</h1>

        <!-- Graphiques -->
        <div class="plots mb-4">
            <div id="div_temp">
                {{ plot_temp|safe }}
            </div>
            <div id="div_hum">
                {{ plot_hum|safe }}
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Filtre par capteur -->
            <div>
                <label for="sensorFilter">Filtrer par capteur :</label>
                <select id="sensorFilter" class="form-select">
                    <option value="">Tous</option>
                    {% for sensor in capteurs_uniques %}
                    <option value="{{ sensor }}">{{ sensor }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Boutons Export -->
            <div class="d-flex gap-2">
                <a href="{% url 'export_csv' %}" class="btn btn-primary">ðŸ“¤ Exporter CSV</a>
                <a href="{% url 'export_json' %}" class="btn btn-success">ðŸ“¤ Exporter JSON</a>
            </div>
        </div>

        <!-- DerniÃ¨res lectures -->
        <h2>DerniÃ¨res lectures (en temps rÃ©el)</h2>
        <table class="table table-bordered" id="last-readings">
            <thead>
                <tr>
                    <th>Sensor</th>
                    <th>TempÃ©rature (Â°C)</th>
                    <th>HumiditÃ© (%)</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                <!-- Contenu injectÃ© par JS -->
            </tbody>
        </table>

        <!-- Tableau complet MongoDB -->
        <h2>ðŸ“Š DonnÃ©es des capteurs (MongoDB)</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Sensor</th>
                    <th>TempÃ©rature (Â°C)</th>
                    <th>HumiditÃ© (%)</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in donnees %}
                <tr>
                    <td>{{ doc.id }}</td>
                    <td>{{ doc.sensor_name }}</td>
                    <td>{{ doc.temperature }}</td>
                    <td>{{ doc.humidite }}</td>
                    <td>{{ doc.timestamp }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">Aucune donnÃ©e</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const sensorFilter = document.getElementById("sensorFilter");

        // Fonction pour mettre Ã  jour le tableau des derniÃ¨res lectures
        async function updateLastReadings() {
            try {
                const response = await fetch("{% url 'dernieres_lectures_api' %}");
                const data = await response.json();

                const tbody = document.querySelector("#last-readings tbody");
                tbody.innerHTML = "";

                let selected = sensorFilter.value.trim();
                let filteredRows = data.rows;

                if (selected) {
                    filteredRows = data.rows.filter(r => r.sensor_name === selected);
                }

                if (filteredRows.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='4'>Aucune donnÃ©e</td></tr>";
                } else {
                    filteredRows.forEach(r => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                    <td>${r.sensor_name}</td>
                    <td>${r.temperature.toFixed(2)}</td>
                    <td>${r.humidite.toFixed(2)}</td>
                    <td>${r.timestamp}</td>
                `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error("Erreur lors du chargement des donnÃ©es :", error);
            }
        }

        // Initialisation
        updateLastReadings();
        setInterval(updateLastReadings, 5000);
        sensorFilter.addEventListener("change", updateLastReadings);
    </script>
</body>

</html>